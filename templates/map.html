<!doctype html>
<html lang="ko">

<head>
  <meta charset="utf-8" />
  <title>POSTECH Campus Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/mapStyle.css') }}" />
  <!--<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>-->
</head>

<body>
  <div class="page-wrapper">
    <!-- 상단 바 -->
    <div class="top-bar">
      <div>
        <div class="top-title">POSTECH Campus Map</div>
        <div class="top-sub">
          교내 시설을 한 곳에서 검색하고 예약하세요 ·
          Search and reserve on-campus facilities in one place
        </div>
      </div>
      <div class="d-flex align-items-center">
        <div class="user-pill">
          {% if user.is_guest %}
          Guest Mode
          {% else %}
          {{ user.name }} 님
          {% endif %}
        </div>
        {% if user.is_guest %}
        <a href="{{ url_for('login') }}" class="btn btn-sm btn-outline-secondary mr-2">Login</a>
        {% else %}
        <a href="{{ url_for('logout') }}" class="btn btn-sm btn-outline-secondary mr-2">Logout</a>
        {% endif %}
      </div>
    </div>

    <!-- 왼쪽 패널 + 지도 -->
    <div class="map-layout">
      <div class="left-panel">
        <!-- Category & Search -->
        <div class="form-group">
          <label>Category / 카테고리</label>
          <select class="form-control form-control-sm" id="categorySelect">
            <option value="All">All · 전체</option>
            <option value="Restaurant">Restaurant · 식당</option>
            <option value="Cafe">Cafe · 카페</option>
            <option value="Printer">Printer · 프린터</option>
            <option value="GS25">Convenience Store · 편의점</option>
            <option value="GSR">GSR · 스터디룸</option>
            <option value="Sports">Sports · 운동시설</option>
            <option value="Dormitory">Dormitory · 기숙사</option>
            <option value="Parking">Parking · 주차장</option>
            <option value="Others">Others · 기타</option>
          </select>
        </div>

        <div class="form-group">
          <label>Search / 검색</label>
          <input type="text" id="searchInput" class="form-control form-control-sm"
            placeholder="예: 지곡, 청암, dormitory..." />
        </div>

        <!-- Navigation card -->
        <div class="nav-card">
          <div class="nav-card-header">
            Navigation · 길 안내 (Walk / 도보)
          </div>

          <div class="nav-row">
            <label>출발지(Start)</label>
            <div class="nav-field-group">
              <button id="startPickerBtn" class="nav-select-btn">
                <span id="startLabel" class="nav-label-text">
                  클릭 후 아이콘 선택 · Tap then pick on map
                </span>
              </button>
              <button id="useCurrentBtn" class="nav-sub-btn">
                현재 위치
              </button>
            </div>
          </div>

          <div class="nav-row">
            <label>도착지(Destination)</label>
            <div class="nav-field-group">
              <span id="destLabel" class="nav-label-text">
                시설 아이콘에서 ‘길 안내’ 버튼을 눌러 설정하세요.
              </span>
            </div>
          </div>

          <div class="nav-row nav-actions">
            <button id="routeBtn" class="primary-btn">
              경로 안내 · Show Route
            </button>
            <button id="clearRouteBtn" class="ghost-btn">
              초기화 · Clear
            </button>
          </div>

          <div id="route-info"></div>
          <small class="small-label">
            데모 버전: 두 지점을 직선 경로로 연결해 도보 거리와 시간을 계산합니다.
            실제 서비스에서는 Kakao Mobility 길찾기 API로 교체할 수 있습니다.
          </small>
        </div>

        <div class="mt-auto pt-3 small-label text-muted">
          로그인한 사용자만 예약이 가능합니다.<br />
          Only logged-in users can make reservations.
        </div>
      </div>

      <!-- 지도 -->
      <div id="map"></div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

  <script type="text/javascript"
    src="https://dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_js_key }}&libraries=services"></script>
  <script type="text/javascript"
    src="https://dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_js_key }}&libraries=services"></script>
  <script>
    let map;
    let allFacilities = [];
    let facilityMarkers = [];   // { marker, facility, iconUrl }
    let activeOverlay = null;

    let currentLang = 'ko';
    let isDragging = false;

    let currentPosition = null;
    let currentLocationMarker = null;

    let startFacility = null;
    let destFacility = null;
    let pickingStart = false;
    let routePolyline = null;

    const CURRENT_ICON = "{{ url_for('static', filename='images/current_location.jpg') }}";
    const IS_GUEST = {{ 'true' if user.is_guest else 'false' }};

        /* === [NEW] Restaurant metadata for detailed popups === */
    const restaurantInfo = {
      jigok: {
        name: "지곡회관 식당 · Jigok Dining Hall",
        type: "Campus Cafeteria",
        hours: [
          {
            labelKo: "조식",
            labelEn: "Breakfast",
            time: "07:30–09:30",
            noteKo: "(주말/공휴일/방학 08:00–09:30)",
            noteEn: "(weekend/holiday/vacation 08:00–09:30)"
          },
          {
            labelKo: "중식",
            labelEn: "Lunch",
            time: "11:30–13:30"
          },
          {
            labelKo: "석식",
            labelEn: "Dinner",
            time: "17:30–19:00"
          },
          {
            labelKo: "연중무휴",
            labelEn: "Open throughout the year"
          }
        ],
        menus: {
          breakfast: {
            title: "조식 · BREAKFAST",
            items: [
              "어묵국 · Fish Cake Soup",
              "떡갈비야채볶음 · Stir-fried Tteokgalbi with Vegetables",
              "시래기조림 · Braised Dried Radish Greens",
              "깻잎순나물 · Seasoned Perilla Shoots",
              "873 kcal · 41 g protein",
              "미니브런치 · Mini Brunch — 848 kcal · 27 g protein"
            ]
          },
          lunch: {
            title: "중식 · LUNCH",
            items: [
              "돼지국밥 · Pork Rice Soup",
              "부추겉절이 · Fresh Chive Kimchi",
              "청포묵김무침 · Seasoned Mung Bean Jelly with Seaweed",
              "사과주스 · Apple Juice",
              "607 kcal · 33 g protein"
            ]
          },
          dinner: {
            title: "석식 · DINNER",
            items: [
              "소고기배추국 · Beef & Napa Cabbage Soup",
              "코다리조림 · Braised Half-dried Pollack (Kodari Jorim)",
              "미니돈까스강정 · Mini Pork Cutlet Glazed Bites",
              "치커리토마토무침 · Seasoned Chicory & Tomato",
              "1657 kcal · 63 g protein"
            ]
          }
        }
      },

      studentHall: {
        name: "학생식당 · Student Hall Cafeteria",
        type: "Campus Cafeteria",
        hours: [
          {
            labelKo: "중식",
            labelEn: "Lunch",
            time: "11:30–13:30"
          },
          {
            labelKo: "석식",
            labelEn: "Dinner",
            time: "17:30–19:00",
            noteKo: "(방학기간 석식 미운영)",
            noteEn: "(No dinner service during vacation)"
          },
          {
            labelKo: "주말/공휴일 휴무",
            labelEn: "Closed on weekends/holidays"
          }
        ],
        menus: {
          onePot: {
            title: "그여든 (One Pot Meal)",
            items: [
              "제육김치덮밥 · Spicy Stir-fried Pork & Kimchi Rice — 6,000 won",
              "강된장비빔밥 · Seasoned Soybean Paste Bibimbap (LIMITED) — 6,000 won",
              "야채김밥 · Vegetable Gimbap (LIMITED) — 2,200 won",
              "참치김밥 · Tuna Gimbap (LIMITED) — 2,500 won",
              "숯불돼지불고기덮밥 · Pork Bulgogi Rice — 6,000 won"
            ]
          },
          makki: {
            title: "마싰는끼니 (MAKKI)",
            items: [
              "돈까스카레덮밥 · Pork Cutlet with Curry & Rice — 6,500 won",
              "고구마돈까스 · Sweet Potato Pork Cutlet — 6,300 won",
              "갈릭돈가스 · Pork Cutlet with Garlic Sauce — 5,800 won",
              "콩국수&만두 · Soymilk Noodle Soup & Dumpling — 6,700 won",
              "라면 · Ramyeon — 2,200 won",
              "공기밥 · Steamed Rice — 700 won",
              "차돌숙주라면 · Beef Brisket & Mung Bean Sprouts Ramyeon — 4,300 won"
            ]
          },
          dinner: {
            title: "석식 · DINNER",
            items: [
              "통살치킨까스 · Chicken Cutlet — 5,800 won"
            ]
          }
        }
      },

      tongnamu: {
        name: "통나무집 · Tongnamujip",
        type: "Korean Pub / Late-night Restaurant",
        hours: [
          {
            labelKo: "영업시간",
            labelEn: "Opening Hours",
            time: "18:00–02:00",
            noteKo: "(토요일 18:00–01:00)",
            noteEn: "(Sat 18:00–01:00)"
          },
          {
            labelKo: "라스트 오더",
            labelEn: "Last Order",
            time: "01:00"
          },
          {
            labelKo: "일요일/공휴일 휴무",
            labelEn: "Closed on Sundays/holidays",
            noteKo: "(방학 기간: 주말/공휴일 휴무)",
            noteEn: "(Vacation: closed on weekends/holidays)"
          }
        ],
        menus: {
          simple: {
            title: "대표 메뉴 · Representative Menu",
            items: [
              "치킨, 튀김류, 한식 안주 등 (상세 메뉴는 추후 업데이트 예정)"
            ]
          }
        }
      },

      burgerKing: {
        name: "버거킹 포스텍점 · Burger King POSTECH",
        type: "Fast Food",
        hours: [
          {
            labelKo: "영업시간",
            labelEn: "Opening Hours",
            time: "11:00–20:00"
          },
          {
            labelKo: "휴무일",
            labelEn: "Closed on",
            noteKo: "신정 / 설날 / 추석연휴 / 크리스마스",
            noteEn: "New Year’s Day, Lunar New Year, Chuseok holidays, Christmas"
          }
        ],
        menus: {
          simple: {
            title: "대표 메뉴 · Representative Menu",
            items: [
              "와퍼, 치즈버거, 감자튀김, 음료 등 (상세 메뉴는 버거킹 공식 메뉴 참고)"
            ]
          }
        }
      }
    };

    // 대상 시설을 key로 매핑
    function getRestaurantKeyFromFacility(facility) {
      const nameKo = facility.name_ko || "";
      const nameEn = (facility.name_en || "").toLowerCase();

      if (facility.id === 1 || nameKo.includes("지곡회관")) return "jigok";
      if (facility.id === 2 || nameKo.includes("학생회관")) return "studentHall";
      if (facility.id === 5 || nameKo.includes("버거킹")) return "burgerKing";
      if (facility.id === 63 || nameKo.includes("통나무집")) return "tongnamu";

      return null;
    }

    // ---- 아이콘 매핑: 이전 프로젝트 규칙 그대로 반영 ----
    function getIconUrlForFacility(facility) {
      const name = facility.name_ko || "";
      const cat = facility.category || "";

      // 1) Restaurant
      if (cat === "Restaurant") {
        // 버거킹만 전용 아이콘
        if (name.includes("버거킹")) {
          return "{{ url_for('static', filename='logos/FacilityMarks/BurgerKing.JPG') }}";
        }
        return "{{ url_for('static', filename='logos/FacilityMarks/RestaurantMark.JPG') }}";
      }

      // 2) Cafe
      if (cat === "Cafe") {
        return "{{ url_for('static', filename='logos/FacilityMarks/CafeIcon.JPG') }}";
      }

      // 3) Printer
      if (cat === "Printer") {
        return "{{ url_for('static', filename='logos/FacilityMarks/PrinterMark.JPG') }}";
      }

      // 4) GS25
      if (cat === "GS25") {
        return "{{ url_for('static', filename='logos/FacilityMarks/GS25.JPG') }}";
      }

      // 5) GSR
      if (cat === "GSR") {
        return "{{ url_for('static', filename='logos/FacilityMarks/GSR.JPG') }}";
      }

      // 6) Sports
      if (cat === "Sports") {
        // 예전: i==0 운동장→PlayGround, i==2 테니스장→Tennis, i==3 체육관→Gym, 나머지→Football
        if (name.includes("운동장")) {
          return "{{ url_for('static', filename='logos/FacilityMarks/PlayGround.JPG') }}";
        }
        if (name.includes("테니스")) {
          return "{{ url_for('static', filename='logos/FacilityMarks/Tennis.JPG') }}";
        }
        if (name.includes("체육관")) {
          return "{{ url_for('static', filename='logos/FacilityMarks/Gym.JPG') }}";
        }
        if (name.includes("포스플렉스")) {
          return "{{ url_for('static', filename='logos/FacilityMarks/Gym.JPG') }}";
        }
        // 풋살장, 포스플렉스 등 나머지
        return "{{ url_for('static', filename='logos/FacilityMarks/Football.JPG') }}";
      }

      // 7) Dormitory (기숙사) – 예전 OthersPositions 0~27 아이콘 매핑 복원
      if (cat === "Dormitory") {
        // 남학생 생활관 1~19동 → blue1~blue19
        if (name.includes("남학생 생활관 1동")) return "{{ url_for('static', filename='logos/FacilityMarks/blue1.JPG') }}";
        if (name.includes("남학생 생활관 2동")) return "{{ url_for('static', filename='logos/FacilityMarks/blue2.JPG') }}";
        if (name.includes("남학생 생활관 3동")) return "{{ url_for('static', filename='logos/FacilityMarks/blue3.JPG') }}";
        if (name.includes("남학생 생활관 4동")) return "{{ url_for('static', filename='logos/FacilityMarks/blue4.JPG') }}";
        if (name.includes("남학생 생활관 5동")) return "{{ url_for('static', filename='logos/FacilityMarks/blue5.JPG') }}";
        if (name.includes("남학생 생활관 6동")) return "{{ url_for('static', filename='logos/FacilityMarks/blue6.JPG') }}";
        if (name.includes("남학생 생활관 7동")) return "{{ url_for('static', filename='logos/FacilityMarks/blue7.JPG') }}";
        if (name.includes("남학생 생활관 8동")) return "{{ url_for('static', filename='logos/FacilityMarks/blue8.JPG') }}";
        if (name.includes("남학생 생활관 9동")) return "{{ url_for('static', filename='logos/FacilityMarks/blue9.JPG') }}";
        if (name.includes("남학생 생활관 10동")) return "{{ url_for('static', filename='logos/FacilityMarks/blue10.JPG') }}";
        if (name.includes("남학생 생활관 11동")) return "{{ url_for('static', filename='logos/FacilityMarks/blue11.JPG') }}";
        if (name.includes("남학생 생활관 12동")) return "{{ url_for('static', filename='logos/FacilityMarks/blue12.JPG') }}";
        if (name.includes("남학생 생활관 13동")) return "{{ url_for('static', filename='logos/FacilityMarks/blue13.JPG') }}";
        if (name.includes("남학생 생활관 14동")) return "{{ url_for('static', filename='logos/FacilityMarks/blue14.JPG') }}";
        if (name.includes("남학생 생활관 15동")) return "{{ url_for('static', filename='logos/FacilityMarks/blue15.JPG') }}";
        if (name.includes("남학생 생활관 16동")) return "{{ url_for('static', filename='logos/FacilityMarks/blue16.JPG') }}";
        if (name.includes("남학생 생활관 17동")) return "{{ url_for('static', filename='logos/FacilityMarks/blue17.JPG') }}";
        if (name.includes("남학생 생활관 18동")) return "{{ url_for('static', filename='logos/FacilityMarks/blue18.JPG') }}";
        if (name.includes("남학생 생활관 19동")) return "{{ url_for('static', filename='logos/FacilityMarks/blue19.JPG') }}";

        // RC 20, 21동 → yellow20, yellow21
        if (name.includes("RC 20동")) return "{{ url_for('static', filename='logos/FacilityMarks/yellow20.JPG') }}";
        if (name.includes("RC 21동")) return "{{ url_for('static', filename='logos/FacilityMarks/yellow21.JPG') }}";

        // 여학생 생활관 1~3동 → red1~3
        if (name.includes("여학생 생활관 1동")) return "{{ url_for('static', filename='logos/FacilityMarks/red1.JPG') }}";
        if (name.includes("여학생 생활관 2동")) return "{{ url_for('static', filename='logos/FacilityMarks/red2.JPG') }}";
        if (name.includes("여학생 생활관 3동")) return "{{ url_for('static', filename='logos/FacilityMarks/red3.JPG') }}";

        // 대학원 아파트 1~4동 → green1~4
        if (name.includes("대학원 아파트 1동")) return "{{ url_for('static', filename='logos/FacilityMarks/green1.JPG') }}";
        if (name.includes("대학원 아파트 2동")) return "{{ url_for('static', filename='logos/FacilityMarks/green2.JPG') }}";
        if (name.includes("대학원 아파트 3동")) return "{{ url_for('static', filename='logos/FacilityMarks/green3.JPG') }}";
        if (name.includes("대학원 아파트 4동")) return "{{ url_for('static', filename='logos/FacilityMarks/green4.JPG') }}";

        // 혹시 이름이 안 맞으면 기본 기숙사 아이콘
        return "{{ url_for('static', filename='logos/FacilityMarks/Dormitory.JPG') }}";
      }

      // 8) Parking
      if (cat === "Parking") {
        return "{{ url_for('static', filename='logos/FacilityMarks/ParkingLot.JPG') }}";
      }

      // 9) Others – 도서관/국제관/상점/학과건물 등 (예전 OthersPositions 28~44)
      if (cat === "Others") {
        // 청암 / Library
        if (name.includes("청암학술정보관")) {
          return "{{ url_for('static', filename='logos/FacilityMarks/Library.JPG') }}";
        }
        // POSCO 국제관
        if (name.includes("국제관")) {
          return "{{ url_for('static', filename='logos/FacilityMarks/Posco.JPG') }}";
        }
        // 기념품샵
        if (name.includes("기념품샵")) {
          return "{{ url_for('static', filename='logos/FacilityMarks/Souvenir.JPG') }}";
        }
        // 통나무집
        if (name.includes("통나무집")) {
          return "{{ url_for('static', filename='logos/FacilityMarks/LogCabinMark.JPG') }}";
        }
        // 안경점
        if (name.includes("안경점")) {
          return "{{ url_for('static', filename='logos/FacilityMarks/Glasses.JPG') }}";
        }

        // ---- 학과 건물 12개: DepartmentsMark 이하 ----
        if (name.startsWith("기계공학과")) {
          return "{{ url_for('static', filename='logos/DepartmentsMark/Mechanic.JPG') }}";
        }
        if (name.startsWith("무은재기념관")) {
          return "{{ url_for('static', filename='logos/DepartmentsMark/Mueunjae.JPG') }}";
        }
        if (name.startsWith("물리학과")) {
          return "{{ url_for('static', filename='logos/DepartmentsMark/Physics.JPG') }}";
        }
        if (name.startsWith("산업경영공학과")) {
          return "{{ url_for('static', filename='logos/DepartmentsMark/Industry.JPG') }}";
        }
        if (name.startsWith("생명과학과")) {
          return "{{ url_for('static', filename='logos/DepartmentsMark/Life.JPG') }}";
        }
        if (name.startsWith("수학과")) {
          return "{{ url_for('static', filename='logos/DepartmentsMark/Math.JPG') }}";
        }
        if (name.startsWith("신소재공학과")) {
          return "{{ url_for('static', filename='logos/DepartmentsMark/Material.JPG') }}";
        }
        if (name.startsWith("전자전기공학과")) {
          return "{{ url_for('static', filename='logos/DepartmentsMark/Electronic.JPG') }}";
        }
        if (name.startsWith("컴퓨터공학과")) {
          return "{{ url_for('static', filename='logos/DepartmentsMark/Computer.JPG') }}";
        }
        if (name.startsWith("화학공학과")) {
          return "{{ url_for('static', filename='logos/DepartmentsMark/ChemicalEngineering.JPG') }}";
        }
        if (name.startsWith("화학과")) {
          return "{{ url_for('static', filename='logos/DepartmentsMark/Chemistry.JPG') }}";
        }
        if (name.startsWith("IT융합공학과")) {
          return "{{ url_for('static', filename='logos/DepartmentsMark/Cite.JPG') }}";
        }
        if (name.startsWith("포항 체인지업")) {
          return "{{ url_for('static', filename='logos/FacilityMarks/CHANGeUP.png') }}";
        }


        // Others 기본
        return "{{ url_for('static', filename='logos/FacilityMarks/Default.JPG') }}";
      }

      // 혹시 카테고리가 이상하면 Default
      return "{{ url_for('static', filename='logos/FacilityMarks/Default.JPG') }}";
    }

    // ----- 초기화 -----
    $(function () {
      initLangToggle();
      initMap();
      initNavUI();
      loadFacilities();
      initCurrentLocation();

  
      $('#resDuration').on('input', function() {
        const mins = parseInt($(this).val());
        const h = Math.floor(mins / 60);
        const m = mins % 60;
        $('#durationLabel').text(`${h} h ${m} min`);
      });
    });

    function initLangToggle() {
      const $buttons = $('#langToggle button');
      $buttons.on('click', function () {
        const lang = $(this).data('lang');
        currentLang = lang;
        $buttons.removeClass('active');
        $(this).addClass('active');
        if (activeOverlay && activeOverlay._facility) {
          showFacilityOverlay(activeOverlay._facility);
        }
      });
    }

    function initMap() {
      const mapContainer = document.getElementById('map');
      const mapOption = {
        center: new kakao.maps.LatLng(36.01449, 129.32154),
        level: 3
      };
      map = new kakao.maps.Map(mapContainer, mapOption);

      kakao.maps.event.addListener(map, 'dragstart', function () {
        isDragging = true;
      });
      kakao.maps.event.addListener(map, 'dragend', function () {
        setTimeout(function () { isDragging = false; }, 50);
      });
      kakao.maps.event.addListener(map, 'click', function () {
        if (isDragging) return;
        closeOverlay();
      });

      // 줌 레벨 바뀔 때 마커 크기 조정
      kakao.maps.event.addListener(map, 'zoom_changed', function () {
        const level = map.getLevel();
        facilityMarkers.forEach(obj => {
          const img = buildScaledMarkerImage(obj.iconUrl, level);
          obj.marker.setImage(img);
        });
      });
    }

    function initNavUI() {
      const startPickerBtn = document.getElementById('startPickerBtn');
      const startLabel = document.getElementById('startLabel');
      const useCurrentBtn = document.getElementById('useCurrentBtn');
      const routeBtn = document.getElementById('routeBtn');
      const clearRouteBtn = document.getElementById('clearRouteBtn');

      startPickerBtn.addEventListener('click', () => {
        pickingStart = !pickingStart;
        startPickerBtn.classList.toggle('active', pickingStart);
        if (pickingStart) {
          startLabel.textContent = '아이콘을 클릭해서 출발지를 선택하세요.';
        } else {
          if (!startFacility && !(startLabel.textContent.includes('현재 위치'))) {
            startLabel.textContent = '클릭 후 아이콘 선택 · Tap then pick on map';
          }
        }
      });

      useCurrentBtn.addEventListener('click', () => {
        if (!currentPosition) {
          alert('현재 위치 정보를 가져올 수 없습니다. 위치 권한을 허용해 주세요.');
          initCurrentLocation();
          return;
        }
        startFacility = null;
        pickingStart = false;
        startPickerBtn.classList.remove('active');
        startLabel.textContent = '현재 위치 (My location)';
      });

      routeBtn.addEventListener('click', handleRoute);
      clearRouteBtn.addEventListener('click', clearRoute);
    }

    function initCurrentLocation() {
      if (!navigator.geolocation) {
        console.warn("Geolocation not supported");
        return;
      }
      navigator.geolocation.getCurrentPosition(
        function (pos) {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          currentPosition = new kakao.maps.LatLng(lat, lng);

          if (currentLocationMarker) {
            currentLocationMarker.setMap(null);
          }
          const img = new kakao.maps.MarkerImage(
            CURRENT_ICON,
            new kakao.maps.Size(26, 26),
            { offset: new kakao.maps.Point(13, 13) }
          );
          currentLocationMarker = new kakao.maps.Marker({
            position: currentPosition,
            image: img,
            zIndex: 999
          });
          currentLocationMarker.setMap(map);
        },
        function (err) {
          console.warn("Cannot get current position:", err);
        }
      );
    }

    // ----- 시설 로딩 & 필터링 -----
    function loadFacilities() {
      fetch('/api/facilities')
        .then(res => res.json())
        .then(data => {
          allFacilities = data;
          renderMarkers();
          bindFilterEvents();
        })
        .catch(err => console.error(err));
    }

    function bindFilterEvents() {
      $('#categorySelect').on('change', renderMarkers);
      $('#searchInput').on('input', function () {
        clearTimeout(window._searchTimer);
        window._searchTimer = setTimeout(renderMarkers, 200);
      });
    }

    function getFilteredFacilities() {
      const category = $('#categorySelect').val();
      const q = ($('#searchInput').val() || '').toLowerCase().trim();

      return allFacilities.filter(f => {
        if (category && category !== 'All' && f.category !== category) return false;
        if (q) {
          const text = (f.name_ko + ' ' + f.name_en + ' ' + f.desc_ko + ' ' + f.desc_en).toLowerCase();
          if (!text.includes(q)) return false;
        }
        return true;
      });
    }

    function buildScaledMarkerImage(iconUrl, level) {
      const baseSize = 32;              // level 3 기준
      const scale = 3 / level;          // level 커질수록 작게
      const size = Math.max(18, baseSize * scale);
      return new kakao.maps.MarkerImage(
        iconUrl,
        new kakao.maps.Size(size, size),
        { offset: new kakao.maps.Point(size / 2, size) }
      );
    }

    function renderMarkers() {
      // 기존 마커 제거
      facilityMarkers.forEach(obj => obj.marker.setMap(null));
      facilityMarkers = [];
      closeOverlay();

      const facilities = getFilteredFacilities();
      const level = map.getLevel();

      facilities.forEach(facility => {
        const pos = new kakao.maps.LatLng(facility.lat, facility.lng);
        const iconUrl = getIconUrlForFacility(facility);   // ★ 여기 변경
        const markerImage = buildScaledMarkerImage(iconUrl, level);

        const marker = new kakao.maps.Marker({
          position: pos,
          image: markerImage,
          map: map
        });

        const markerObj = { marker, facility, iconUrl };
        facilityMarkers.push(markerObj);

        kakao.maps.event.addListener(marker, 'click', function () {
          handleMarkerClick(markerObj);
        });
      });
    }

    function handleMarkerClick(markerObj) {
      const facility = markerObj.facility;
      const startLabel = document.getElementById('startLabel');

      // 출발지 선택 모드인 경우
      if (pickingStart) {
        startFacility = facility;
        pickingStart = false;
        document.getElementById('startPickerBtn').classList.remove('active');
        startLabel.textContent = `${facility.name_ko} / ${facility.name_en}`;
        return;
      }

      // [NEW] 식당 상세 오버레이 대상인지 체크
      const restKey = getRestaurantKeyFromFacility(facility);
      if (restKey) {
        showRestaurantOverlay(facility, restKey);
        return;
      }

      // 일반 클릭: 오버레이 열기
      showFacilityOverlay(facility);
    }

    /* === [NEW] Restaurant overlay builder === */
    function buildRestaurantOverlayHTML(data) {
      const hoursLines = (data.hours || [])
        .map(h => {
          const label =
            (h.labelKo || h.labelEn)
              ? `<strong>${h.labelKo || ""}${h.labelEn ? " / " + h.labelEn : ""}</strong> `
              : "";
          const time = h.time ? `${h.time}` : "";
          const noteKo = h.noteKo ? ` <span style="font-size:11px; color:#666;">${h.noteKo}</span>` : "";
          const noteEn = h.noteEn ? ` <span style="font-size:11px; color:#999;">${h.noteEn}</span>` : "";
          return `<li style="margin-bottom:4px;">${label}${time}${noteKo}${noteEn}</li>`;
        })
        .join("");

      let menuSections = "";
      const menus = data.menus || {};
      Object.values(menus).forEach(section => {
        const itemsHTML = (section.items || [])
          .map(item => `<li style="margin-bottom:2px;">${item}</li>`)
          .join("");
        menuSections += `
          <details style="margin-bottom:6px;">
            <summary style="font-weight:600; cursor:pointer;">${section.title}</summary>
            <ul style="margin-top:4px; padding-left:18px; font-size:13px;">
              ${itemsHTML}
            </ul>
          </details>
        `;
      });

      return `
        <div class="restaurant-overlay-inner"
             style="
              width: 600px;
              max-height: 1000px;
              overflow-y: auto;
              background:#ffffff;
              border-radius: 12px;
              box-shadow: 0 4px 16px rgba(0,0,0,0.25);
              padding: 12px 14px;
              box-sizing:border-box;
              font-family: -apple-system, BlinkMacSystemFont, 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif;
             ">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <div>
              <div style="font-size:15px; font-weight:700;">${data.name}</div>
              ${data.type ? `<div style="font-size:11px; color:#777;">${data.type}</div>` : ""}
            </div>
            <button type="button"
                    class="restaurant-overlay-close"
                    style="
                      border:none;
                      background:transparent;
                      font-size:18px;
                      line-height:1;
                      cursor:pointer;
                      padding:0 4px;
                      color:#666;
                    ">
              ×
            </button>
          </div>

          <div style="margin-bottom:8px; border-bottom:1px solid #eee; padding-bottom:6px;">
            <div style="font-size:12px; font-weight:600; margin-bottom:4px;">영업 정보 · Opening Hours</div>
            <ul style="margin:0; padding-left:18px; font-size:12px;">
              ${hoursLines}
            </ul>
          </div>

          <div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
              <div style="font-size:12px; font-weight:600;">메뉴 · Menu</div>
              <button type="button"
                      class="restaurant-overlay-nav-btn"
                      style="
                        border-radius: 999px;
                        border: none;
                        background:#c41f3e;
                        color:#fff;
                        font-size:11px;
                        padding:4px 10px;
                        cursor:pointer;
                      ">
                길 안내 (Route)
              </button>
            </div>
            ${menuSections}
          </div>
        </div>
      `;
    }

    function showRestaurantOverlay(facility, key) {
      const data = restaurantInfo[key];
      if (!data) {
        // 정보 없으면 기존 오버레이로 fallback
        showFacilityOverlay(facility);
        return;
      }

      closeOverlay();

      const pos = new kakao.maps.LatLng(facility.lat, facility.lng);
      const wrapper = document.createElement('div');
      wrapper.className = 'restaurant-overlay';
      wrapper.innerHTML = buildRestaurantOverlayHTML(data);

      // 닫기 버튼
      const closeBtn = wrapper.querySelector('.restaurant-overlay-close');
      if (closeBtn) {
        closeBtn.addEventListener('click', closeOverlay);
      }

      // 길 안내 버튼 (기존 nav 로직 재사용)
      const navBtn = wrapper.querySelector('.restaurant-overlay-nav-btn');
      if (navBtn) {
        navBtn.addEventListener('click', function () {
          destFacility = facility;
          const destLabel = document.getElementById('destLabel');
          destLabel.textContent = `${facility.name_ko} / ${facility.name_en}`;
          map.panTo(pos);
        });
      }

      const overlay = new kakao.maps.CustomOverlay({
        position: pos,
        yAnchor: 1.1,
        xAnchor: 0.5,
        content: wrapper,
        clickable: true
      });
      overlay._facility = facility;
      overlay.setMap(map);
      activeOverlay = overlay;
    }

    // ----- 시설 오버레이 -----
    function showFacilityOverlay(facility) {
      closeOverlay();

      const pos = new kakao.maps.LatLng(facility.lat, facility.lng);
      const wrapper = document.createElement('div');
      wrapper.className = 'facility-overlay';

      const nameKo = facility.name_ko || "";
      const nameEn = (facility.name_en || "").toLowerCase();
      const cat = facility.category;

      // Identify "Gym" to exclude it from Sports
      const isGym = nameKo.includes('체육관') || nameEn.includes('gym') || nameKo.includes('포스플렉스');

      // Define Reservable Categories
      const isSports = (cat === 'Sports') && !isGym;
      const isGSR = (cat === 'GSR');

      // Library: Check for 'Cheongam' or 'Library', but explicitly EXCLUDE convenience stores/GS25
      const isConvenience = (cat === 'GS25') || nameEn.includes('convenience') || nameKo.includes('편의점');
      const isLibraryBuild = (nameKo.includes('청암') || nameEn.includes('library')) && !isConvenience && (cat !== 'Printer');

      // Final check
      const isReservable = isSports || isGSR || isLibraryBuild;

      wrapper.innerHTML = `
      <div class="overlay-header">
        <div>
          <div class="overlay-title">
            ${facility.name_ko}
          </div>
          <div class="overlay-sub">${facility.name_en}</div>
          <span class="overlay-category">${facility.category}</span>
        </div>
        <button class="overlay-close" type="button">&times;</button>
      </div>
      <div class="overlay-body">
        <div>${facility.desc_ko || ''}</div>
        <div class="overlay-sub">${facility.desc_en || ''}</div>
      </div>
      <div class="overlay-actions">
        <button type="button" class="overlay-nav-btn">
          길 안내 (Route)
        </button>
        ${
        // [New Logic] 2. Only render button/badge if isReservable is true
        !isReservable
          ? ''
          : (IS_GUEST
            ? '<span class="badge-guest">Guest · 예약 불가</span>'
            : '<button type="button" class="overlay-reserve-btn">예약하기 (Reserve)</button>'
          )
        }
      </div>
    `;

      const closeBtn = wrapper.querySelector('.overlay-close');
      closeBtn.addEventListener('click', closeOverlay);

      // 길 안내 버튼
      const navBtn = wrapper.querySelector('.overlay-nav-btn');
      navBtn.addEventListener('click', function () {
        destFacility = facility;
        const destLabel = document.getElementById('destLabel');
        destLabel.textContent = `${facility.name_ko} / ${facility.name_en}`;
        map.panTo(pos);
      });

      // [New Logic] 3. Bind click event only if button exists
      if (!IS_GUEST && isReservable) {
        const reserveBtn = wrapper.querySelector('.overlay-reserve-btn');
        if (reserveBtn) {
          reserveBtn.addEventListener('click', function () {
            handleReservation(facility);
          });
        }
      }

      const overlay = new kakao.maps.CustomOverlay({
        position: pos,
        yAnchor: 1.05,
        xAnchor: 0.5,
        content: wrapper,
        clickable: true
      });
      overlay._facility = facility;
      overlay.setMap(map);
      activeOverlay = overlay;
    }

    function closeOverlay() {
      if (activeOverlay) {
        activeOverlay.setMap(null);
        activeOverlay = null;
      }
    }

    // ----- 예약 처리 -----
    // ----- OLD handleReservation REPLACED WITH MODAL LOGIC ----- 

    // ----- Updated handleReservation -----
    function handleReservation(facility) {
      // 1. Reset Modal Fields
      $('#resFacilityId').val(facility.id);
      $('#resTime').val('');
      $('#resDuration').val('1'); // Default to 1 hour
      $('#resMemo').val('');
      $('#resAlert').addClass('d-none').text('');
      
      // 2. Set Title
      $('#resModalTitle').text(`Reserve: ${facility.name_ko}`);

      // [Removed] Old seat/library logic is gone. Duration applies to all.

      // 3. Show Modal
      $('#reservationModal').modal('show');
    }

    // ----- Updated submitReservation -----
    function submitReservation() {
      const facilityId = $('#resFacilityId').val();
      const timeSlot = $('#resTime').val();
      const duration = $('#resDuration').val(); // Get duration
      const memo = $('#resMemo').val();

      if (!timeSlot) {
        alert('시간을 선택해주세요 / Please select a time.');
        return;
      }

      fetch('/api/reserve', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          facility_id: parseInt(facilityId),
          time_slot: timeSlot,
          duration: parseInt(duration), // Send duration to server
          memo: memo
        })
      })
        .then(res => res.json().then(body => ({ ok: res.ok, status: res.status, body })))
        .then(({ ok, status, body }) => {
          if (!ok || !body.ok) {
            const errorMsg = body.error || 'Reservation failed.';
            $('#resAlert').removeClass('d-none').text(errorMsg);
          } else {
            $('#reservationModal').modal('hide');
            alert('예약이 완료되었습니다! / Reservation successful!');
          }
        })
        .catch((err) => {
          console.error(err);
          $('#resAlert').removeClass('d-none').text('Server Error');
        });
    }
    // ----- 경로 안내 -----
    // ----- 경로 안내 -----
    function handleRoute() {
      const routeInfo = document.getElementById('route-info');
      if (!destFacility) {
        alert('도착지를 먼저 선택해주세요. 시설 아이콘에서 "길 안내" 버튼을 눌러주세요.');
        return;
      }

      let startLatLng = null;
      if (startFacility) {
        startLatLng = new kakao.maps.LatLng(startFacility.lat, startFacility.lng);
      } else if (currentPosition) {
        startLatLng = currentPosition;
      } else {
        alert('출발지를 선택하거나 현재 위치 정보를 허용해주세요.');
        return;
      }

      const endLatLng = new kakao.maps.LatLng(destFacility.lat, destFacility.lng);

      // 서버에 Kakao Mobility 경로 요청
      const url = `/api/route_walk?origin_lat=${startLatLng.getLat()}&origin_lng=${startLatLng.getLng()}&dest_lat=${endLatLng.getLat()}&dest_lng=${endLatLng.getLng()}`;

      fetch(url)
        .then(res => res.json())
        .then(data => {
          if (!data.ok) {
            alert(data.error || '경로를 가져오지 못했습니다.');
            return;
          }

          // 기존 Polyline 지우기
          if (routePolyline) {
            routePolyline.setMap(null);
            routePolyline = null;
          }

          const path = data.path.map(p => new kakao.maps.LatLng(p.lat, p.lng));

          routePolyline = new kakao.maps.Polyline({
            path: path,
            strokeWeight: 5,
            strokeColor: '#ff0050',
            strokeOpacity: 0.9,
            strokeStyle: 'solid',
            map: map
          });

          // Kakao가 준 distance(자동차 경로 거리)를 그대로 사용하고,
          // 시간은 "도보 기준"으로 다시 계산
          const distance = data.distance; // m
          const walkSpeed = 1.3;          // m/s (약 4.7km/h)
          const seconds = distance / walkSpeed;
          const minutes = Math.round(seconds / 60);

          routeInfo.textContent =
            `거리: 약 ${(distance / 1000).toFixed(2)} km · 예상 도보 ${minutes}분`;

          // 모든 경로가 보이도록 Bounds 설정
          const bounds = new kakao.maps.LatLngBounds();
          path.forEach(latlng => bounds.extend(latlng));
          map.setBounds(bounds);
        })
        .catch(err => {
          console.error(err);
          alert('경로 요청 중 오류가 발생했습니다.');
        });
    }


    function clearRoute() {
      if (routePolyline) {
        routePolyline.setMap(null);
        routePolyline = null;
      }
      startFacility = null;
      destFacility = null;
      pickingStart = false;
      document.getElementById('startPickerBtn').classList.remove('active');
      document.getElementById('startLabel').textContent =
        '클릭 후 아이콘 선택 · Tap then pick on map';
      document.getElementById('destLabel').textContent =
        '시설 아이콘에서 ‘길 안내’ 버튼을 눌러 설정하세요.';
      document.getElementById('route-info').textContent = '';
    }

  </script>


  <div class="modal fade" id="reservationModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="resModalTitle">Facility Reservation</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div id="resAlert" class="alert alert-danger d-none" role="alert"></div>

          <form id="reservationForm">
          <input type="hidden" id="resFacilityId">
          
          <div class="form-group">
            <label for="resTime">Start Time / 시작 시간</label>
            <input type="datetime-local" class="form-control" id="resTime" required>
          </div>

          <div class="form-group">
            <label for="resDuration">
              Duration / 이용 시간: 
              <span id="durationLabel" style="color: #c41f3e; font-weight: bold;">1 h 0 min</span>
            </label>
            <input type="range" class="form-control-range" id="resDuration" 
                   min="30" max="180" step="30" value="60">
            <small class="form-text text-muted">
              Slide to select (30 min ~ 3 hours).
            </small>
          </div>

          <div class="form-group">
            <label for="resMemo">Memo / 메모 (Optional)</label>
            <textarea class="form-control" id="resMemo" rows="2" placeholder="Purpose of use..."></textarea>
          </div>
        </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" onclick="submitReservation()">Confirm Reservation</button>
        </div>
      </div>
    </div>
  </div>
</body>

</html>